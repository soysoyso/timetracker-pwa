<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì—…ë¬´ íŠ¸ë˜ì»¤</title>

    <!-- âœ… Supabase ë¨¼ì € ë¡œë“œ -->
    <script
      src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.42.4/dist/umd/supabase.min.js"
      onload="window.supabaseLoaded = true;"
    ></script>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body>
    <div id="root"></div>

    <!-- âœ… Supabaseê°€ ì™„ì „íˆ ë¡œë“œëœ í›„ ì‹¤í–‰ -->
    <script type="text/babel">
      async function waitForSupabase() {
        while (!window.supabaseLoaded || !window.supabase) {
          console.log("â³ Supabase ë¡œë“œ ëŒ€ê¸° ì¤‘...");
          await new Promise((r) => setTimeout(r, 300));
        }
        console.log("âœ… Supabase ë¡œë“œ ì™„ë£Œ:", window.supabase);
      }

      waitForSupabase().then(() => {
        const { useState, useEffect } = React;

        const SUPABASE_URL = "https://ypdvepbxhedaywdlavap.supabase.co";
        const SUPABASE_ANON_KEY =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwZHZlcGJ4aGVkYXl3ZGxhdmFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNTAyMTYsImV4cCI6MjA3NzkyNjIxNn0.xLrxGb9xsNAzDaozd3m9UjegRkw1Tu6hmTuSj326tWo";

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function handleSave() {
          const { data, error } = await supabase
            .from("work_history")
            .insert([
              {
                user_name: "ìš”ê¹Œì´",
                date: new Date().toISOString().split("T")[0],
                sessions: 1,
                goal_hours: 8,
                satisfaction: 95,
                note: "ë¡œë“œ ì™„ë£Œ í›„ í…ŒìŠ¤íŠ¸ ì €ì¥",
                start_time: "09:00",
                end_time: "18:00",
              },
            ]);

          if (error) {
            console.error("âŒ ì˜¤ë¥˜:", error);
            alert("âŒ ì˜¤ë¥˜ ë°œìƒ: " + error.message);
          } else {
            console.log("âœ… ì €ì¥ ì„±ê³µ:", data);
            alert("âœ… Supabase ì €ì¥ ì„±ê³µ!");
          }
        }

        const App = () => (
          <div className="p-6 text-center">
            <h1 className="text-2xl font-bold mb-4">Supabase ì—°ê²° í…ŒìŠ¤íŠ¸</h1>
            <button
              onClick={handleSave}
              className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
            >
              ì €ì¥ í…ŒìŠ¤íŠ¸
            </button>
          </div>
        );

        ReactDOM.render(<App />, document.getElementById("root"));
      });
  
    // =========================================

    // Lucide ì•„ì´ì½˜ (SVG ê·¸ëŒ€ë¡œ ìœ ì§€)
    const Play = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polygon points="5 3 19 12 5 21 5 3"></polygon>
      </svg>
    );
    const Square = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
      </svg>
    );
    const Clock = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
    );
    const BarChart3 = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M3 3v18h18"></path>
        <path d="M18 17V9"></path>
        <path d="M13 17V5"></path>
        <path d="M8 17v-3"></path>
      </svg>
    );
    const Target = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <circle cx="12" cy="12" r="6"></circle>
        <circle cx="12" cy="12" r="2"></circle>
      </svg>
    );
    const TrendingUp = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
        <polyline points="17 6 23 6 23 12"></polyline>
      </svg>
    );
    const Calendar = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
    );

    const WorkTracker = () => {
      // ============ ìƒˆë¡œ ì¶”ê°€ëœ ì‚¬ìš©ì ì´ë¦„ ê´€ë ¨ State ============
      const [userName, setUserName] = useState('');
      const [showUserNameInput, setShowUserNameInput] = useState(false);
      const [inputUserName, setInputUserName] = useState('');
      const [isAdmin, setIsAdmin] = useState(false);
      
      const [currentWork, setCurrentWork] = useState(null);
      const [lastWorkEnd, setLastWorkEnd] = useState(null);
      const [workSessions, setWorkSessions] = useState([]);
      const [dayStarted, setDayStarted] = useState(false);
      const [dayStartTime, setDayStartTime] = useState(null);
      const [goalHours, setGoalHours] = useState(6);
      const [showGoalInput, setShowGoalInput] = useState(false);
      const [view, setView] = useState('tracker');
      const [statsView, setStatsView] = useState('daily');
      const [showAlert, setShowAlert] = useState(false);
      const [alertMessage, setAlertMessage] = useState('');
      const [workHistory, setWorkHistory] = useState([]);
      const [currentTime, setCurrentTime] = useState(new Date());
      const [skipFocusInput, setSkipFocusInput] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [settings, setSettings] = useState({
        workAlertMinutes: 90,
        breakAlertMinutes: 30
      });
      const [alertDismissed, setAlertDismissed] = useState({
        work: false,
        break: false
      });
      
      // ============ ì¹´í…Œê³ ë¦¬ì— 'ì§ì ‘ì…ë ¥' ì¶”ê°€ ============
      const categories = ['ê¸°íš', 'íšŒì˜', 'í”¼ê·¸ë§ˆì‘ì—…', 'ì§ì ‘ì…ë ¥'];
      const [selectedCategory, setSelectedCategory] = useState('');
      const [workDescription, setWorkDescription] = useState('');
      const [showStartForm, setShowStartForm] = useState(false);
      const [customCategory, setCustomCategory] = useState('');

      // ============ Supabase ê´€ë ¨ State ============
      const [isSyncing, setIsSyncing] = useState(false);
      const [syncStatus, setSyncStatus] = useState(''); // ë™ê¸°í™” ìƒíƒœ ë©”ì‹œì§€

      // ============ Supabase í•¨ìˆ˜ë“¤ ============
      
      // ì„œë²„ì— ë°ì´í„° ì €ì¥
      const saveDayToSupabase = async (dayData) => {
        if (!supabase) {
          console.log('Supabaseê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. localStorageë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.');
          return { success: false, error: 'Supabase not configured' };
        }

        try {
          const { data, error } = await supabase
            .from('work_history')
            .insert([{
              user_name: dayData.userName,
              date: dayData.date,
              sessions: dayData.sessions,
              goal_hours: dayData.goalHours,
              satisfaction: dayData.satisfaction,
              note: dayData.note,
              start_time: dayData.startTime,
              end_time: dayData.endTime
            }]);

          if (error) throw error;
          
          console.log('âœ… ì„œë²„ ì €ì¥ ì„±ê³µ:', dayData.date);
          return { success: true, data };
        } catch (error) {
          console.error('âŒ ì„œë²„ ì €ì¥ ì‹¤íŒ¨:', error);
          return { success: false, error };
        }
      };

      // ì„œë²„ì—ì„œ ë°ì´í„° ë™ê¸°í™”
      const syncFromSupabase = async () => {
        if (!supabase || !userName) return;

        setIsSyncing(true);
        setSyncStatus('ì„œë²„ì™€ ë™ê¸°í™” ì¤‘...');

        try {
          let query = supabase
            .from('work_history')
            .select('*')
            .order('created_at', { ascending: true });

          // ì¼ë°˜ ì‚¬ìš©ìëŠ” ìê¸° ë°ì´í„°ë§Œ
          if (!isAdmin) {
            query = query.eq('user_name', userName);
          }
          // ê´€ë¦¬ìëŠ” ëª¨ë“  ë°ì´í„° ì¡°íšŒ

          const { data, error } = await query;

          if (error) throw error;

          // ì„œë²„ ë°ì´í„°ë¥¼ ì•± í˜•ì‹ìœ¼ë¡œ ë³€í™˜
          const serverHistory = data.map(row => ({
            userName: row.user_name,
            date: row.date,
            sessions: row.sessions,
            goalHours: row.goal_hours,
            satisfaction: row.satisfaction,
            note: row.note,
            startTime: row.start_time,
            endTime: row.end_time
          }));

          // localStorageì™€ ë³‘í•© (ì„œë²„ ìš°ì„ )
          const localHistory = JSON.parse(localStorage.getItem('workTrackerHistory') || '[]');
          
          // ì¤‘ë³µ ì œê±° (ê°™ì€ ë‚ ì§œ+ì‚¬ìš©ì)
          const mergedHistory = [...serverHistory];
          localHistory.forEach(local => {
            const exists = serverHistory.some(
              server => server.date === local.date && server.userName === local.userName
            );
            if (!exists) {
              mergedHistory.push(local);
            }
          });

          setWorkHistory(mergedHistory);
          setSyncStatus('âœ… ë™ê¸°í™” ì™„ë£Œ');
          setTimeout(() => setSyncStatus(''), 3000);

          console.log(`âœ… ì„œë²„ ë™ê¸°í™” ì™„ë£Œ: ${data.length}ê°œ ë ˆì½”ë“œ`);
        } catch (error) {
          console.error('âŒ ë™ê¸°í™” ì‹¤íŒ¨:', error);
          setSyncStatus('âŒ ë™ê¸°í™” ì‹¤íŒ¨');
          setTimeout(() => setSyncStatus(''), 3000);
        } finally {
          setIsSyncing(false);
        }
      };

      // ============ ì‚¬ìš©ì ì´ë¦„ ë¡œë“œ ì‹œ ë™ê¸°í™” ============
      useEffect(() => {
        if (userName && supabase) {
          syncFromSupabase();
        }
      }, [userName, isAdmin]);

      // ============ ì‚¬ìš©ì ì´ë¦„ ë¡œë“œ ë° ì²´í¬ ============
      useEffect(() => {
        const savedUserName = localStorage.getItem('workTrackerUserName');
        if (savedUserName) {
          setUserName(savedUserName);
          setIsAdmin(savedUserName.toLowerCase() === 'admin');
        } else {
          setShowUserNameInput(true);
        }
      }, []);

      useEffect(() => {
        const savedHistory = localStorage.getItem('workTrackerHistory');
        if (savedHistory) {
          try {
            const parsed = JSON.parse(savedHistory);
            setWorkHistory(parsed);
          } catch (e) {
            console.error('Failed to load history:', e);
          }
        }
        
        const savedSettings = localStorage.getItem('workTrackerSettings');
        if (savedSettings) {
          try {
            const parsed = JSON.parse(savedSettings);
            setSettings(parsed);
          } catch (e) {
            console.error('Failed to load settings:', e);
          }
        }
      }, []);

      useEffect(() => {
        if (workHistory.length > 0) {
          localStorage.setItem('workTrackerHistory', JSON.stringify(workHistory));
        }
      }, [workHistory]);

      useEffect(() => {
        const timer = setInterval(() => {
          setCurrentTime(new Date());
        }, 1000);
        return () => clearInterval(timer);
      }, []);

      // ============ ì‚¬ìš©ì ì´ë¦„ ì €ì¥ í•¨ìˆ˜ ============
      const saveUserName = () => {
        if (!inputUserName.trim()) {
          alert('ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
          return;
        }
        localStorage.setItem('workTrackerUserName', inputUserName);
        setUserName(inputUserName);
        setIsAdmin(inputUserName.toLowerCase() === 'admin');
        setShowUserNameInput(false);
      };

      const formatDate = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const dayOfWeek = days[date.getDay()];
        return { year, month, day, dayOfWeek };
      };

      const formatCurrentTime = (date) => {
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
      };

      const dateInfo = formatDate(currentTime);

      useEffect(() => {
        const interval = setInterval(() => {
          const now = Date.now();
          
          if (lastWorkEnd && !currentWork && !alertDismissed.break) {
            const breakMinutes = (now - lastWorkEnd) / (1000 * 60);
            if (breakMinutes > settings.breakAlertMinutes) {
              setAlertMessage('ì¼í•´ì•¼í•©ë‹ˆë‹¤ì¼ì¼ì¼ì´ì¼ ğŸ’ª');
              setShowAlert(true);
            }
          }
          
          if (currentWork && !alertDismissed.work) {
            const workMinutes = (now - currentWork.startTime) / (1000 * 60);
            if (workMinutes > settings.workAlertMinutes) {
              setAlertMessage('íœ´ì‹ê³¼ ìš´ë™ì´ í•„ìš”í•©ë‹ˆë‹¤ ğŸ§˜ ìŠ¤íŠ¸ë ˆì¹­');
              setShowAlert(true);
            }
          }
        }, 30000);

        return () => clearInterval(interval);
      }, [currentWork, lastWorkEnd, settings, alertDismissed]);

      const formatTime = (ms) => {
        const hours = Math.floor(ms / (1000 * 60 * 60));
        const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
        return `${hours}ì‹œê°„ ${minutes}ë¶„`;
      };

      const formatHM = (ms) => {
        const hours = Math.floor(ms / (1000 * 60 * 60));
        const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
        return { hours, minutes };
      };

      const startDay = () => {
        setShowGoalInput(true);
      };

      const confirmGoal = () => {
        const startTime = Date.now();
        const date = new Date(startTime);
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const timeStr = `${month}.${day} ${hours}:${minutes}`;
        
        setDayStarted(true);
        setDayStartTime(startTime);
        setShowGoalInput(false);
        
        const startSession = {
          category: 'ì‹œì‘',
          description: `í•˜ë£¨ ì‹œì‘ - ${timeStr}`,
          startTime: startTime,
          endTime: startTime,
          duration: 0,
          focusLevel: '-'
        };
        setWorkSessions([startSession]);
      };

      const openStartForm = () => {
        setShowStartForm(true);
        setSelectedCategory('');
        setWorkDescription('');
        setCustomCategory('');
      };

      const startWork = () => {
        const finalCategory = selectedCategory === 'ì§ì ‘ì…ë ¥' ? customCategory : selectedCategory;
        
        if (!finalCategory || !workDescription.trim()) {
          alert('ì¹´í…Œê³ ë¦¬ì™€ ì‘ì—… ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
          return;
        }
        
        if (selectedCategory === 'ì§ì ‘ì…ë ¥' && !customCategory.trim()) {
          alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”');
          return;
        }
        
        setCurrentWork({
          category: finalCategory,
          description: workDescription,
          startTime: Date.now(),
          focusLevel: null
        });
        setShowStartForm(false);
        setShowAlert(false);
        setAlertDismissed({ ...alertDismissed, work: false });
      };

      const stopWork = () => {
        if (!currentWork) return;
        
        let focusLevel;
        if (skipFocusInput) {
          focusLevel = '2';
        } else {
          focusLevel = prompt('ì§‘ì¤‘ë„ë¥¼ í‰ê°€í•´ì£¼ì„¸ìš”\nìƒ: 3, ì¤‘: 2, í•˜: 1', '2');
        }
        
        const focusMap = { '1': 'í•˜', '2': 'ì¤‘', '3': 'ìƒ' };
        
        const session = {
          ...currentWork,
          endTime: Date.now(),
          focusLevel: focusMap[focusLevel] || 'ì¤‘',
          duration: Date.now() - currentWork.startTime
        };
        
        setWorkSessions([...workSessions, session]);
        setLastWorkEnd(Date.now());
        setCurrentWork(null);
        setShowAlert(false);
        setAlertDismissed({ ...alertDismissed, break: false });
      };

      const endDay = async () => {
        const satisfaction = prompt('ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ í‰ê°€í•´ì£¼ì„¸ìš” (1-5ì )', '3');
        const note = prompt('ì˜¤ëŠ˜ í•˜ë£¨ í•œì¤„ íšŒê³ ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”', '');
        
        const endTime = Date.now();
        const date = new Date(endTime);
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const timeStr = `${month}.${day} ${hours}:${minutes}`;
        
        const endSession = {
          category: 'ë§ˆê°',
          description: `í•˜ë£¨ ë§ˆê° - ${timeStr}`,
          startTime: endTime,
          endTime: endTime,
          duration: 0,
          focusLevel: '-'
        };
        
        const finalSessions = [...workSessions, endSession];
        
        const dayData = {
          userName: userName,
          date: new Date().toLocaleDateString('ko-KR'),
          sessions: finalSessions,
          goalHours,
          satisfaction: satisfaction || '3',
          note: note || '',
          startTime: dayStartTime,
          endTime: endTime
        };
        
        // localStorageì— ì €ì¥
        const newHistory = [...workHistory, dayData];
        setWorkHistory(newHistory);
        
        // Supabaseì— ì €ì¥ (ë¹„ë™ê¸°)
        if (supabase) {
          setSyncStatus('ì„œë²„ì— ì €ì¥ ì¤‘...');
          const result = await saveDayToSupabase(dayData);
          if (result.success) {
            setSyncStatus('âœ… ì„œë²„ ì €ì¥ ì™„ë£Œ');
          } else {
            setSyncStatus('âš ï¸ ì„œë²„ ì €ì¥ ì‹¤íŒ¨ (ë¡œì»¬ì—ëŠ” ì €ì¥ë¨)');
          }
          setTimeout(() => setSyncStatus(''), 3000);
        }
        
        setDayStarted(false);
        setCurrentWork(null);
        setWorkSessions([]);
        setLastWorkEnd(null);
        setView('stats');
      };

      const exportData = () => {
        const dataStr = JSON.stringify(workHistory, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `work-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
      };

      const clearData = () => {
        if (confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
          localStorage.removeItem('workTrackerHistory');
          setWorkHistory([]);
          alert('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      };

      const saveSettings = () => {
        localStorage.setItem('workTrackerSettings', JSON.stringify(settings));
        setShowSettings(false);
        alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! âœ…');
      };

      const getFilteredHistory = () => {
        if (isAdmin) {
          return workHistory;
        }
        // userNameì´ ì—†ëŠ” ê¸°ì¡´ ë°ì´í„°ëŠ” í˜„ì¬ ì‚¬ìš©ì ê²ƒìœ¼ë¡œ ê°„ì£¼
        return workHistory.filter(day => 
          !day.userName || day.userName === userName
        );
      };

      const calculateStats = () => {
        const workOnlySessions = workSessions.filter(s => s.category !== 'ì‹œì‘' && s.category !== 'ë§ˆê°');
        
        const totalWork = workOnlySessions.reduce((acc, s) => acc + s.duration, 0);
        const totalBreak = workOnlySessions.reduce((acc, s, i) => {
          if (i === 0) return acc;
          return acc + (s.startTime - workOnlySessions[i-1].endTime);
        }, 0);
        
        const byCategory = {};
        const uniqueCategories = [...new Set(workOnlySessions.map(s => s.category))];
        uniqueCategories.forEach(cat => {
          byCategory[cat] = workOnlySessions
            .filter(s => s.category === cat)
            .reduce((acc, s) => acc + s.duration, 0);
        });

        return { totalWork, totalBreak, byCategory };
      };

      const stats = calculateStats();

      const dismissAlert = (action) => {
        setShowAlert(false);
        
        if (action === 'rest') {
          stopWork();
          setAlertDismissed({ ...alertDismissed, work: true });
        } else if (action === 'work') {
          openStartForm();
          setAlertDismissed({ ...alertDismissed, break: true });
        } else if (action === 'continue') {
          if (currentWork) {
            setAlertDismissed({ ...alertDismissed, work: true });
          } else {
            setAlertDismissed({ ...alertDismissed, break: true });
          }
        }
      };

      const getWeeklyStats = () => {
        const filteredHistory = getFilteredHistory();
        const lastSevenDays = filteredHistory.slice(-7);
        const totalWork = lastSevenDays.reduce((acc, day) => {
          const workOnlySessions = day.sessions.filter(s => s.category !== 'ì‹œì‘' && s.category !== 'ë§ˆê°');
          return acc + workOnlySessions.reduce((sum, s) => sum + s.duration, 0);
        }, 0);
        return { days: lastSevenDays.length, totalWork };
      };

      const getMonthlyStats = () => {
        const filteredHistory = getFilteredHistory();
        const lastThirtyDays = filteredHistory.slice(-30);
        const totalWork = lastThirtyDays.reduce((acc, day) => {
          const workOnlySessions = day.sessions.filter(s => s.category !== 'ì‹œì‘' && s.category !== 'ë§ˆê°');
          return acc + workOnlySessions.reduce((sum, s) => sum + s.duration, 0);
        }, 0);
        return { days: lastThirtyDays.length, totalWork };
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 pb-20">
          {showUserNameInput && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-6">
              <div className="bg-white rounded-3xl p-8 max-w-sm w-full">
                <div className="text-center mb-6">
                  <div className="text-6xl mb-4">ğŸ‘¤</div>
                  <h2 className="text-2xl font-bold text-gray-800 mb-2">í™˜ì˜í•©ë‹ˆë‹¤!</h2>
                  <p className="text-gray-600">ì—…ë¬´ íŠ¸ë˜ì»¤ë¥¼ ì‹œì‘í•˜ê¸° ì „ì—<br/>ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                </div>
                
                <div className="mb-6">
                  <label className="block text-gray-700 mb-3 font-medium">ì‚¬ìš©ì ì´ë¦„</label>
                  <input
                    type="text"
                    value={inputUserName}
                    onChange={(e) => setInputUserName(e.target.value)}
                    placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                    className="w-full p-4 border-2 border-gray-300 rounded-xl text-center text-lg"
                    onKeyPress={(e) => e.key === 'Enter' && saveUserName()}
                  />
                  <p className="text-xs text-gray-500 mt-2 text-center">
                    ì…ë ¥í•œ ì´ë¦„ìœ¼ë¡œ ë°ì´í„°ê°€ êµ¬ë¶„ë©ë‹ˆë‹¤
                  </p>
                </div>
                
                <button
                  onClick={saveUserName}
                  className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-indigo-700"
                >
                  ì‹œì‘í•˜ê¸° ğŸš€
                </button>
              </div>
            </div>
          )}

          {showAlert && (
            <div className="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-6">
              <div className="bg-white rounded-3xl p-8 text-center max-w-sm w-full animate-bounce">
                <div className="text-6xl mb-4">âš ï¸</div>
                <h2 className="text-2xl font-bold text-gray-800 mb-6 leading-tight">
                  {alertMessage}
                </h2>
                <div className="space-y-3">
                  {alertMessage.includes('íœ´ì‹') && (
                    <>
                      <button
                        onClick={() => dismissAlert('rest')}
                        className="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-green-700"
                      >
                        íœ´ì‹í•˜ê¸° â˜•
                      </button>
                      <button
                        onClick={() => dismissAlert('continue')}
                        className="w-full bg-gray-500 text-white py-4 rounded-xl font-bold text-lg hover:bg-gray-600"
                      >
                        ê³„ì† ì¼í•˜ê¸° ğŸ’ª
                      </button>
                    </>
                  )}
                  
                  {alertMessage.includes('ì¼í•´ì•¼') && (
                    <>
                      <button
                        onClick={() => dismissAlert('work')}
                        className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-indigo-700"
                      >
                        ì¼í•˜ê¸° ğŸ’¼
                      </button>
                      <button
                        onClick={() => dismissAlert('continue')}
                        className="w-full bg-gray-500 text-white py-4 rounded-xl font-bold text-lg hover:bg-gray-600"
                      >
                        ê³„ì† íœ´ì‹ ğŸ˜´
                      </button>
                    </>
                  )}
                </div>
              </div>
            </div>
          )}

          {showGoalInput && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-6">
              <div className="bg-white rounded-3xl p-8 max-w-sm w-full">
                <div className="text-center mb-6 pb-6 border-b border-gray-200">
                  <div className="text-xl font-bold text-gray-800 mb-2">
                    {dateInfo.year}ë…„ {dateInfo.month}ì›” {dateInfo.day}ì¼ ({dateInfo.dayOfWeek})
                  </div>
                  <div className="text-2xl font-mono font-bold text-indigo-600">
                    {formatCurrentTime(currentTime)}
                  </div>
                </div>
                
                <h2 className="text-2xl font-bold text-gray-800 mb-6">ì˜¤ëŠ˜ì˜ ëª©í‘œ ì„¤ì •</h2>
                <div className="mb-6">
                  <label className="block text-gray-700 mb-3 font-medium">ëª©í‘œ ì‘ì—…ì‹œê°„</label>
                  <input
                    type="number"
                    value={goalHours}
                    onChange={(e) => setGoalHours(Number(e.target.value))}
                    className="w-full p-4 border-2 border-gray-300 rounded-xl text-2xl text-center font-bold"
                    min="1"
                    max="12"
                  />
                  <p className="text-gray-500 text-sm mt-2 text-center">ì‹œê°„</p>
                </div>
                <button
                  onClick={confirmGoal}
                  className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-indigo-700"
                >
                  í•˜ë£¨ ì‹œì‘! ğŸš€
                </button>
              </div>
            </div>
          )}

          {showStartForm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-6">
              <div className="bg-white rounded-3xl p-8 max-w-sm w-full">
                <h2 className="text-2xl font-bold text-gray-800 mb-6">ì‘ì—… ì‹œì‘</h2>
                
                <div className="mb-6">
                  <label className="block text-gray-700 mb-3 font-medium">ì¹´í…Œê³ ë¦¬</label>
                  <div className="grid grid-cols-2 gap-2">
                    {categories.map(cat => (
                      <button
                        key={cat}
                        onClick={() => setSelectedCategory(cat)}
                        className={`py-3 px-2 rounded-xl font-bold text-sm ${
                          selectedCategory === cat
                            ? 'bg-indigo-600 text-white'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}
                      >
                        {cat}
                      </button>
                    ))}
                  </div>
                </div>

                {selectedCategory === 'ì§ì ‘ì…ë ¥' && (
                  <div className="mb-6">
                    <label className="block text-gray-700 mb-3 font-medium">ì¹´í…Œê³ ë¦¬ ì§ì ‘ ì…ë ¥</label>
                    <input
                      type="text"
                      value={customCategory}
                      onChange={(e) => setCustomCategory(e.target.value)}
                      placeholder="ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                      className="w-full p-4 border-2 border-indigo-300 rounded-xl bg-indigo-50"
                    />
                  </div>
                )}

                <div className="mb-6">
                  <label className="block text-gray-700 mb-3 font-medium">ì‘ì—… ë‚´ìš©</label>
                  <input
                    type="text"
                    value={workDescription}
                    onChange={(e) => setWorkDescription(e.target.value)}
                    placeholder="ë¬´ì—‡ì„ í•˜ì‹œë‚˜ìš”?"
                    className="w-full p-4 border-2 border-gray-300 rounded-xl"
                  />
                </div>

                <div className="flex gap-3">
                  <button
                    onClick={() => setShowStartForm(false)}
                    className="flex-1 bg-gray-200 text-gray-700 py-4 rounded-xl font-bold hover:bg-gray-300"
                  >
                    ì·¨ì†Œ
                  </button>
                  <button
                    onClick={startWork}
                    className="flex-1 bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-700"
                  >
                    ì‹œì‘!
                  </button>
                </div>
              </div>
            </div>
          )}

          {showSettings && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-6">
              <div className="bg-white rounded-3xl p-8 max-w-sm w-full">
                <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                  <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  ì•Œë¦¼ ì„¤ì •
                </h2>
                
                <div className="space-y-6">
                  <div>
                    <label className="block text-gray-700 mb-3 font-medium">
                      ì—…ë¬´ ì•Œë¦¼ â°
                      <span className="block text-sm text-gray-500 font-normal mt-1">
                        ì´ ì‹œê°„ ì´ìƒ ì‘ì—…í•˜ë©´ íœ´ì‹ ì•Œë¦¼
                      </span>
                    </label>
                    <div className="flex items-center gap-3">
                      <input
                        type="number"
                        value={settings.workAlertMinutes}
                        onChange={(e) => setSettings({...settings, workAlertMinutes: Number(e.target.value)})}
                        className="flex-1 p-4 border-2 border-gray-300 rounded-xl text-xl text-center font-bold"
                        min="1"
                        max="180"
                      />
                      <span className="text-gray-700 font-medium">ë¶„</span>
                    </div>
                  </div>

                  <div>
                    <label className="block text-gray-700 mb-3 font-medium">
                      íœ´ì‹ ì•Œë¦¼ â˜•
                      <span className="block text-sm text-gray-500 font-normal mt-1">
                        ì´ ì‹œê°„ ì´ìƒ ì‰¬ë©´ ì—…ë¬´ ì‹œì‘ ì•Œë¦¼
                      </span>
                    </label>
                    <div className="flex items-center gap-3">
                      <input
                        type="number"
                        value={settings.breakAlertMinutes}
                        onChange={(e) => setSettings({...settings, breakAlertMinutes: Number(e.target.value)})}
                        className="flex-1 p-4 border-2 border-gray-300 rounded-xl text-xl text-center font-bold"
                        min="1"
                        max="120"
                      />
                      <span className="text-gray-700 font-medium">ë¶„</span>
                    </div>
                  </div>
                </div>

                <div className="flex gap-3 mt-8">
                  <button
                    onClick={() => setShowSettings(false)}
                    className="flex-1 bg-gray-200 text-gray-700 py-4 rounded-xl font-bold hover:bg-gray-300"
                  >
                    ì·¨ì†Œ
                  </button>
                  <button
                    onClick={saveSettings}
                    className="flex-1 bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-700"
                  >
                    ì €ì¥
                  </button>
                </div>
              </div>
            </div>
          )}

          <div className="bg-white shadow-md">
            <div className="max-w-md mx-auto px-6 py-6">
              <div className="flex justify-between items-start">
                <div>
                  <h1 className="text-3xl font-bold text-gray-800">â±ï¸ ì—…ë¬´ íŠ¸ë˜ì»¤</h1>
                  <p className="text-gray-600 mt-1">
                    ë‚˜ë¥¼ ì•Œì•„ê°€ëŠ” ì‹œê°„ 
                    {userName && (
                      <span className="ml-2 text-indigo-600 font-semibold">
                        ({userName}{isAdmin && ' ğŸ‘‘'})
                      </span>
                    )}
                  </p>
                  {/* ë™ê¸°í™” ìƒíƒœ í‘œì‹œ */}
                  {syncStatus && (
                    <div className="mt-2 text-sm text-indigo-600 font-medium">
                      {syncStatus}
                    </div>
                  )}
                </div>
                <button
                  onClick={() => setShowSettings(true)}
                  className="p-3 hover:bg-gray-100 rounded-xl transition-colors"
                  title="ì„¤ì •"
                >
                  <svg className="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                </button>
              </div>
              
              {dayStarted && (
                <div className="mt-4 pt-4 border-t border-gray-200">
                  <div className="flex justify-between items-center mb-3">
                    <div className="flex items-center gap-3">
                      <div className="text-lg font-bold text-gray-800">
                        {dateInfo.year}ë…„ {dateInfo.month}ì›” {dateInfo.day}ì¼
                      </div>
                      <div className="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full font-bold text-sm">
                        {dateInfo.dayOfWeek}ìš”ì¼
                      </div>
                    </div>
                    <div className="text-xl font-mono font-bold text-indigo-600">
                      {formatCurrentTime(currentTime)}
                    </div>
                  </div>
                  
                  <div className="flex items-center gap-2">
                    <input
                      type="checkbox"
                      id="skipFocusInput"
                      checked={skipFocusInput}
                      onChange={(e) => setSkipFocusInput(e.target.checked)}
                      className="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                    />
                    <label htmlFor="skipFocusInput" className="text-sm text-gray-700 cursor-pointer select-none">
                      ì§‘ì¤‘ë„ ì…ë ¥ ì œì™¸ (ê¸°ë³¸ê°’: ì¤‘)
                    </label>
                  </div>
                </div>
              )}
            </div>
          </div>

          <div className="max-w-md mx-auto px-6 mt-6">
            <div className="flex gap-2 bg-white rounded-2xl p-2">
              <button
                onClick={() => setView('tracker')}
                className={`flex-1 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 ${
                  view === 'tracker'
                    ? 'bg-indigo-600 text-white'
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
              >
                <Clock size={20} />
                íŠ¸ë˜ì»¤
              </button>
              <button
                onClick={() => setView('stats')}
                className={`flex-1 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2 ${
                  view === 'stats'
                    ? 'bg-indigo-600 text-white'
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
              >
                <BarChart3 size={20} />
                í†µê³„
              </button>
            </div>
          </div>

          <div className="max-w-md mx-auto px-6 mt-6">
            {view === 'tracker' ? (
              <>
                {!dayStarted ? (
                  <div className="bg-white rounded-3xl p-8 text-center shadow-lg">
                    <div className="mb-6 pb-6 border-b border-gray-200">
                      <div className="text-2xl font-bold text-gray-800 mb-2">
                        {dateInfo.year}ë…„ {dateInfo.month}ì›” {dateInfo.day}ì¼
                      </div>
                      <div className="flex items-center justify-center gap-3 mb-3">
                        <div className="bg-indigo-100 text-indigo-800 px-4 py-2 rounded-full font-bold">
                          {dateInfo.dayOfWeek}ìš”ì¼
                        </div>
                      </div>
                      <div className="text-3xl font-mono font-bold text-indigo-600">
                        {formatCurrentTime(currentTime)}
                      </div>
                    </div>
                    
                    <div className="text-6xl mb-4">ğŸŒ…</div>
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">
                      ì˜¤ëŠ˜ì˜ ì—…ë¬´ë¥¼ ì‹œì‘í•˜ì„¸ìš”
                    </h2>
                    <button
                      onClick={startDay}
                      className="w-full bg-indigo-600 text-white py-5 rounded-2xl font-bold text-xl hover:bg-indigo-700 shadow-lg"
                    >
                      í•˜ë£¨ ì‹œì‘
                    </button>
                  </div>
                ) : (
                  <>
                    <div className="bg-white rounded-3xl p-6 shadow-lg mb-6">
                      {currentWork ? (
                        <div className="text-center">
                          <div className="inline-block bg-green-100 text-green-800 px-4 py-2 rounded-full font-bold mb-4">
                            {currentWork.category}
                          </div>
                          <h3 className="text-xl font-bold text-gray-800 mb-2">
                            {currentWork.description}
                          </h3>
                          <LiveTimer startTime={currentWork.startTime} />
                          <button
                            onClick={stopWork}
                            className="w-full bg-red-500 text-white py-5 rounded-2xl font-bold text-xl mt-6 hover:bg-red-600 shadow-lg flex items-center justify-center gap-3"
                          >
                            <Square size={24} />
                            ì‘ì—… ì¢…ë£Œ
                          </button>
                        </div>
                      ) : (
                        <div className="text-center">
                          <div className="text-5xl mb-4">â˜•</div>
                          <h3 className="text-xl font-bold text-orange-600 mb-4">íœ´ì‹ ì¤‘</h3>
                          <div className="mb-2 text-gray-600 font-medium">íœ´ì‹ ì‹œê°„</div>
                          <BreakTimer startTime={lastWorkEnd || dayStartTime} />
                          <button
                            onClick={openStartForm}
                            className="w-full bg-indigo-600 text-white py-5 rounded-2xl font-bold text-xl mt-6 hover:bg-indigo-700 shadow-lg flex items-center justify-center gap-3"
                          >
                            <Play size={24} />
                            ì‘ì—… ì‹œì‘
                          </button>
                        </div>
                      )}
                    </div>

                    <div className="bg-white rounded-3xl p-6 shadow-lg mb-6">
                      <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <Target size={20} />
                        ì˜¤ëŠ˜ì˜ ì§„í–‰ìƒí™©
                      </h3>
                      
                      <div className="mb-6">
                        <div className="flex justify-between mb-2">
                          <span className="text-gray-600 font-medium">ëª©í‘œ ë‹¬ì„±ë¥ </span>
                          <span className="font-bold text-indigo-600">
                            {((stats.totalWork / (goalHours * 60 * 60 * 1000)) * 100).toFixed(0)}%
                          </span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-4">
                          <div
                            className="bg-gradient-to-r from-indigo-500 to-purple-500 h-4 rounded-full transition-all"
                            style={{
                              width: `${Math.min(((stats.totalWork / (goalHours * 60 * 60 * 1000)) * 100), 100)}%`
                            }}
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div className="bg-indigo-50 rounded-2xl p-4">
                          <div className="text-indigo-600 text-sm font-medium mb-1">ì´ ì‘ì—…</div>
                          <div className="text-2xl font-bold text-indigo-900">
                            {formatHM(stats.totalWork).hours}h {formatHM(stats.totalWork).minutes}m
                          </div>
                        </div>
                        <div className="bg-orange-50 rounded-2xl p-4">
                          <div className="text-orange-600 text-sm font-medium mb-1">ì´ íœ´ì‹</div>
                          <div className="text-2xl font-bold text-orange-900">
                            {formatHM(stats.totalBreak).hours}h {formatHM(stats.totalBreak).minutes}m
                          </div>
                        </div>
                      </div>

                      {Object.keys(stats.byCategory).length > 0 && (
                        <div className="mt-6 space-y-3">
                          {Object.keys(stats.byCategory).map(cat => {
                            const duration = stats.byCategory[cat] || 0;
                            const percentage = stats.totalWork > 0 ? (duration / stats.totalWork * 100) : 0;
                            return (
                              <div key={cat}>
                                <div className="flex justify-between mb-1">
                                  <span className="text-gray-700 font-medium">{cat}</span>
                                  <span className="text-gray-600">
                                    {formatHM(duration).hours}h {formatHM(duration).minutes}m
                                  </span>
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-2">
                                  <div
                                    className="bg-indigo-500 h-2 rounded-full"
                                    style={{ width: `${percentage}%` }}
                                  />
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>

                    <div className="bg-white rounded-3xl p-6 shadow-lg mb-6">
                      <h3 className="text-lg font-bold text-gray-800 mb-4">ì˜¤ëŠ˜ì˜ ì„¸ì…˜</h3>
                      {workSessions.length === 0 ? (
                        <p className="text-gray-500 text-center py-8">ì•„ì§ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</p>
                      ) : (
                        <div className="space-y-3">
                          {workSessions.map((session, i) => {
                            const borderColor = 
                              session.category === 'ì‹œì‘' ? 'border-green-500' :
                              session.category === 'ë§ˆê°' ? 'border-purple-500' :
                              'border-indigo-500';
                            
                            const bgColor = 
                              session.category === 'ì‹œì‘' ? 'bg-green-50' :
                              session.category === 'ë§ˆê°' ? 'bg-purple-50' :
                              'bg-gray-50';
                            
                            const badgeColor = 
                              session.category === 'ì‹œì‘' ? 'bg-green-100 text-green-800' :
                              session.category === 'ë§ˆê°' ? 'bg-purple-100 text-purple-800' :
                              'bg-indigo-100 text-indigo-800';
                            
                            return (
                              <div key={i} className={`border-l-4 ${borderColor} ${bgColor} rounded-lg p-4`}>
                                <div className="flex justify-between items-start mb-2">
                                  <div>
                                    <span className={`inline-block ${badgeColor} px-2 py-1 rounded text-xs font-bold mb-1`}>
                                      {session.category}
                                    </span>
                                    <div className="font-medium text-gray-800">{session.description}</div>
                                  </div>
                                  {session.focusLevel !== '-' && (
                                    <span className="text-xs bg-gray-200 px-2 py-1 rounded">
                                      ì§‘ì¤‘ë„: {session.focusLevel}
                                    </span>
                                  )}
                                </div>
                                {session.duration > 0 && (
                                  <div className="text-sm text-gray-600">
                                    {formatTime(session.duration)}
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>

                    <button
                      onClick={endDay}
                      className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-5 rounded-2xl font-bold text-xl hover:from-purple-700 hover:to-indigo-700 shadow-lg"
                    >
                      í•˜ë£¨ ë§ˆê°í•˜ê¸°
                    </button>
                  </>
                )}
              </>
            ) : (
              <>
                {isAdmin && (
                  <div className="bg-gradient-to-r from-yellow-400 to-orange-400 rounded-2xl p-4 mb-4 text-center shadow-lg">
                    <div className="text-2xl mb-1">ğŸ‘‘</div>
                    <div className="text-white font-bold">ê´€ë¦¬ì ëª¨ë“œ</div>
                    <div className="text-white text-sm">ëª¨ë“  ì‚¬ìš©ìì˜ ë°ì´í„°ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
                  </div>
                )}

                <div className="flex gap-2 mb-6">
                  {['daily', 'weekly', 'monthly'].map(period => (
                    <button
                      key={period}
                      onClick={() => setStatsView(period)}
                      className={`flex-1 py-3 rounded-xl font-bold ${
                        statsView === period
                          ? 'bg-white text-indigo-600 shadow-md'
                          : 'bg-white/50 text-gray-600'
                      }`}
                    >
                      {period === 'daily' ? 'ì¼ê°„' : period === 'weekly' ? 'ì£¼ê°„' : 'ì›”ê°„'}
                    </button>
                  ))}
                </div>

                {statsView === 'daily' && getFilteredHistory().length > 0 && (
                  <div className="space-y-4">
                    {getFilteredHistory().slice(-7).reverse().map((day, i) => {
                      const workOnlySessions = day.sessions.filter(s => s.category !== 'ì‹œì‘' && s.category !== 'ë§ˆê°');
                      const totalWork = workOnlySessions.reduce((acc, s) => acc + s.duration, 0);
                      const goalReached = totalWork >= (day.goalHours * 60 * 60 * 1000);
                      
                      return (
                        <div key={i} className="bg-white rounded-3xl p-6 shadow-lg">
                          <div className="flex justify-between items-start mb-4">
                            <div>
                              <h3 className="text-lg font-bold text-gray-800">{day.date}</h3>
                              {isAdmin && day.userName && (
                                <div className="text-sm text-indigo-600 font-semibold mt-1">
                                  ğŸ‘¤ {day.userName}
                                </div>
                              )}
                              <p className="text-sm text-gray-600 mt-1">{day.note}</p>
                            </div>
                            <div className="text-right">
                              <div className="text-2xl mb-1">
                                {'â­'.repeat(parseInt(day.satisfaction))}
                              </div>
                              {goalReached && <div className="text-2xl">ğŸ¯</div>}
                            </div>
                          </div>

                          <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="bg-indigo-50 rounded-xl p-3">
                              <div className="text-indigo-600 text-xs font-medium mb-1">ì‘ì—…ì‹œê°„</div>
                              <div className="text-lg font-bold text-indigo-900">
                                {formatHM(totalWork).hours}h {formatHM(totalWork).minutes}m
                              </div>
                            </div>
                            <div className="bg-purple-50 rounded-xl p-3">
                              <div className="text-purple-600 text-xs font-medium mb-1">ë‹¬ì„±ë¥ </div>
                              <div className="text-lg font-bold text-purple-900">
                                {((totalWork / (day.goalHours * 60 * 60 * 1000)) * 100).toFixed(0)}%
                              </div>
                            </div>
                          </div>

                          <div className="space-y-2">
                            {(() => {
                              const uniqueCategories = [...new Set(workOnlySessions.map(s => s.category))];
                              return uniqueCategories.map(cat => {
                                const catDuration = workOnlySessions
                                  .filter(s => s.category === cat)
                                  .reduce((acc, s) => acc + s.duration, 0);
                                
                                if (catDuration === 0) return null;
                                
                                return (
                                  <div key={cat} className="flex justify-between text-sm">
                                    <span className="text-gray-600">{cat}</span>
                                    <span className="font-medium text-gray-800">
                                      {formatHM(catDuration).hours}h {formatHM(catDuration).minutes}m
                                    </span>
                                  </div>
                                );
                              });
                            })()}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}

                {statsView === 'weekly' && (
                  <div className="bg-white rounded-3xl p-6 shadow-lg">
                    <h3 className="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                      <TrendingUp size={24} />
                      ì£¼ê°„ í†µê³„
                    </h3>
                    {getFilteredHistory().length === 0 ? (
                      <p className="text-gray-500 text-center py-8">ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    ) : (
                      <div className="space-y-6">
                        <div className="grid grid-cols-2 gap-4">
                          <div className="bg-gradient-to-br from-indigo-500 to-purple-500 rounded-2xl p-6 text-white">
                            <div className="text-sm mb-2">ì´ ì‘ì—…ì¼</div>
                            <div className="text-4xl font-bold">{getWeeklyStats().days}ì¼</div>
                          </div>
                          <div className="bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl p-6 text-white">
                            <div className="text-sm mb-2">ì´ ì‘ì—…ì‹œê°„</div>
                            <div className="text-4xl font-bold">
                              {formatHM(getWeeklyStats().totalWork).hours}h
                            </div>
                          </div>
                        </div>

                        <div className="bg-gray-50 rounded-2xl p-6">
                          <div className="text-gray-700 font-medium mb-2">ì¼í‰ê·  ì‘ì—…ì‹œê°„</div>
                          <div className="text-3xl font-bold text-indigo-600">
                            {(formatHM(getWeeklyStats().totalWork / Math.max(getWeeklyStats().days, 1)).hours).toFixed(1)}ì‹œê°„
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {statsView === 'monthly' && (
                  <div className="bg-white rounded-3xl p-6 shadow-lg">
                    <h3 className="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                      <Calendar size={24} />
                      ì›”ê°„ í†µê³„
                    </h3>
                    {getFilteredHistory().length === 0 ? (
                      <p className="text-gray-500 text-center py-8">ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    ) : (
                      <div className="space-y-6">
                        <div className="grid grid-cols-2 gap-4">
                          <div className="bg-gradient-to-br from-blue-500 to-indigo-500 rounded-2xl p-6 text-white">
                            <div className="text-sm mb-2">ì´ ì‘ì—…ì¼</div>
                            <div className="text-4xl font-bold">{getMonthlyStats().days}ì¼</div>
                          </div>
                          <div className="bg-gradient-to-br from-indigo-500 to-purple-500 rounded-2xl p-6 text-white">
                            <div className="text-sm mb-2">ì´ ì‘ì—…ì‹œê°„</div>
                            <div className="text-4xl font-bold">
                              {formatHM(getMonthlyStats().totalWork).hours}h
                            </div>
                          </div>
                        </div>

                        <div className="bg-gray-50 rounded-2xl p-6">
                          <div className="text-gray-700 font-medium mb-2">ì¼í‰ê·  ì‘ì—…ì‹œê°„</div>
                          <div className="text-3xl font-bold text-indigo-600">
                            {(formatHM(getMonthlyStats().totalWork / Math.max(getMonthlyStats().days, 1)).hours).toFixed(1)}ì‹œê°„
                          </div>
                        </div>

                        {getFilteredHistory().length >= 7 && (
                          <div className="bg-green-50 rounded-2xl p-6 text-center">
                            <div className="text-5xl mb-3">ğŸ”¥</div>
                            <div className="text-gray-700 font-medium mb-1">ì—°ì† ì‘ì—…ì¼</div>
                            <div className="text-3xl font-bold text-green-600">
                              {getFilteredHistory().length}ì¼
                            </div>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                )}

                {getFilteredHistory().length === 0 && (
                  <div className="bg-white rounded-3xl p-8 text-center shadow-lg">
                    <div className="text-6xl mb-4">ğŸ“Š</div>
                    <h3 className="text-xl font-bold text-gray-800 mb-2">
                      ì•„ì§ í†µê³„ê°€ ì—†ìŠµë‹ˆë‹¤
                    </h3>
                    <p className="text-gray-600">
                      í•˜ë£¨ë¥¼ ë§ˆê°í•˜ë©´ í†µê³„ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”!
                    </p>
                  </div>
                )}

                {workHistory.length > 0 && (
                  <div className="bg-white rounded-3xl p-6 shadow-lg mt-6">
                    <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                      ğŸ’¾ ë°ì´í„° ê´€ë¦¬
                    </h3>
                    <div className="space-y-3">
                      {supabase && (
                        <button
                          onClick={syncFromSupabase}
                          disabled={isSyncing}
                          className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 flex items-center justify-center gap-2 disabled:opacity-50"
                        >
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                          </svg>
                          {isSyncing ? 'ë™ê¸°í™” ì¤‘...' : 'ì„œë²„ ë™ê¸°í™”'}
                        </button>
                      )}
                      <button
                        onClick={exportData}
                        className="w-full bg-green-600 text-white py-4 rounded-xl font-bold hover:bg-green-700 flex items-center justify-center gap-2"
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        ë°ì´í„° ë°±ì—… (JSON ë‹¤ìš´ë¡œë“œ)
                      </button>
                      <button
                        onClick={clearData}
                        className="w-full bg-red-600 text-white py-4 rounded-xl font-bold hover:bg-red-700 flex items-center justify-center gap-2"
                      >
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                        ëª¨ë“  ë°ì´í„° ì‚­ì œ
                      </button>
                      <div className="text-center text-sm text-gray-500 pt-2">
                        ì´ {workHistory.length}ì¼ì˜ ê¸°ë¡ì´ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤
                        {isAdmin && ` (ëª¨ë“  ì‚¬ìš©ì)`}
                      </div>
                      {supabase && (
                        <div className="text-center text-xs text-blue-600 pt-1">
                          â˜ï¸ ì„œë²„ ë°±ì—… í™œì„±í™”ë¨
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </>
            )}
          </div>
        </div>
      );
    };

    const LiveTimer = ({ startTime }) => {
      const [elapsed, setElapsed] = useState(0);

      useEffect(() => {
        const interval = setInterval(() => {
          setElapsed(Date.now() - startTime);
        }, 1000);

        return () => clearInterval(interval);
      }, [startTime]);

      const hours = Math.floor(elapsed / (1000 * 60 * 60));
      const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);

      return (
        <div className="text-5xl font-bold text-indigo-600 my-6 font-mono">
          {String(hours).padStart(2, '0')}:{String(minutes).padStart(2, '0')}:{String(seconds).padStart(2, '0')}
        </div>
      );
    };

    const BreakTimer = ({ startTime }) => {
      const [elapsed, setElapsed] = useState(0);

      useEffect(() => {
        const interval = setInterval(() => {
          setElapsed(Date.now() - startTime);
        }, 1000);

        return () => clearInterval(interval);
      }, [startTime]);

      const hours = Math.floor(elapsed / (1000 * 60 * 60));
      const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);

      const isWarning = elapsed > 30 * 60 * 1000;

      return (
        <div className={`text-5xl font-bold my-6 font-mono ${isWarning ? 'text-red-600 animate-pulse' : 'text-orange-500'}`}>
          {hours > 0 && `${String(hours).padStart(2, '0')}:`}
          {String(minutes).padStart(2, '0')}:{String(seconds).padStart(2, '0')}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<WorkTracker />);
  </script>
</body>
</html>
